<!Doctype html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link rel="shortcut icon" href="//static.xinshangshangxin.com/favicon.ico">
  <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css">

  <style>
    body {
      font-family: Menlo, Consolas, "Source Code Pro", Inconsolata, Monaco, "Courier New";
      margin: 0 20px;
    }
  </style>
</head>

<body>
<div class="row">
  <div class="col-xs-4">
    <textarea id="dimensions" class="form-control"></textarea>
  </div>
  <div class="col-xs-4">
    <select class="form-control" id="jobName">
    </select>
    <input id="jobNameHandle" type="text">
  </div>
</div>
<div class="row">
  <div class="col-xs-2">
    <button class="btn btn-success copy-btn" data-clipboard-target="#result">复制</button>
  </div>
  <div class="col-xs-10">
    <textarea id="result" class="form-control"></textarea>
  </div>
</div>

<div class="row" style="margin-bottom: 20px;">
  <br>
</div>
<div class="row">
  <div class="col-xs-1">
    <button class="btn btn-success copy-btn" data-clipboard-target="#nginxConf">复制</button>
  </div>
  <div class="col-xs-1">
    <textarea id="port" class="form-control"></textarea>
  </div>
  <div class="col-xs-10">
    <textarea id="domain" class="form-control"></textarea>
  </div>
  <div class="col-xs-12">
    <textarea id="nginxConf" class="form-control"></textarea>
  </div>


  <div class="col-xs-12">
    <br>
    <br>
    <br>
  </div>
  <div class="col-xs-12">
    <textarea id="jobContent" class="form-control"></textarea>
  </div>
  <div class="col-xs-12">
    <table id="jobResult" class="table">
    </table>
  </div>
</div>

<script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="//cdn.bootcss.com/blueimp-md5/2.8.0/js/md5.min.js"></script>
<script src="//cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.7.1/clipboard.min.js"></script>
<script src="//cdn.bootcss.com/lodash.js/4.17.4/lodash.min.js"></script>
<script src="//cdn.bootcss.com/rxjs/5.4.2/Rx.min.js"></script>

<!-- inject:js -->
<script src="json5-1.0.0-beta.min.js"></script>
<!-- endinject -->
<script>
  function loadJobName() {
    var jobCopys = {
      BusinessAreaLabel: {},
      CrossUserCodeMacAddress: {},
      HomeTownshipLabel: {},
      WorkTownshipLabel: {},
      EnterPoiDeviceDate: {},
      EnterLocDeviceDate: {},
      DeviceAppLabel: {
        properties: {
          'cn.magicsdk.cube.connections.input': 'deviceMongo'
        }
      },
      DeviceApps: {
        properties: {
          'cn.magicsdk.cube.connections.input': 'deviceMongo'
        }
      },
      DevicePoiBrandLabel: {},
      DevicePoiCategoryDate: {},
      DevicesTrend: {},
      DevicesTrendByAppWant: {},
      DevicesTrendHeatMap: {},
      DevicesTrendHeatMapByAppWant: {},
      NearbyPoisDeviceTrend: {},
      NearbyPoisTrend: {},
      RealtimeEnterLocDeviceDate: {},
      RealtimeVisitsHeatMapByAppWant: {},
      Test: {},
      UserTypeTrend: {},
      UserTypeTrendByAppWant: {},
      UserTypeTrendHeatMap: {},
      UserTypeTrendHeatMapByAppWant: {},
      VisitsTrend: {},
      VisitsTrendByAppWant: {},
      VisitsTrendHeatMap: {},
      VisitsTrendHeatMapByAppWant: {}
    };

    var options = Object.keys(jobCopys).map(function (key) {
      return `<option value="${key}">${key}</option>`;
    }).join('\n');
    $('#jobName').html(options);
  }

  function getCollectionName(dimensionsStr, jobName) {
    if (!/cn\.magicsdk\.cube\.jobs\./.test(jobName)) {
      jobName = 'cn.magicsdk.cube.jobs.' + jobName;
    }

    var dimensions;
    try {
      dimensions = JSON5.parse(dimensionsStr);
    }
    catch (e) {
      dimensions = dimensionsStr.split(/\s+/);
    }

    dimensionsStr = jobName + ':' + dimensions.sort().join('|');
    console.log('dimensionsStr: ', dimensionsStr);
    return 'cp_' + md5(dimensionsStr);
  }

  function loadBtnCopy() {
    var clipboard = new Clipboard('.copy-btn');

    clipboard.on('success', function (e) {
      console.info('Action:', e.action);
      console.info('Text:', e.text);
      console.info('Trigger:', e.trigger);

      e.clearSelection();
    });

    clipboard.on('error', function (e) {
      console.error('Action:', e.action);
      console.error('Trigger:', e.trigger);
    });

  }

  function getQs() {
    var qs = {};
    location.search.substr(1).split('&').forEach(function (item) {
      var s = item.split('=');
      var k = s[0];
      var v = s[1] && decodeURIComponent(s[1]);
      try {
        v = new Function('return ' + v)();
      } catch (e) {
      }
      (qs[k] = qs[k] || []).push(v);
    });
    Object.keys(qs).forEach(function (key) {
      if (qs[key] && qs[key].length === 1) {
        qs[key] = qs[key][0];
      }
    });

    return qs;
  }

  function getHash() {
    var qs = {};
    location.href.replace(/.*?#\//, '').split('&').forEach(function (item) {
      var s = item.split('=');
      var k = s[0];
      var v = s[1] && decodeURIComponent(s[1]);
      try {
        v = new Function('return ' + v)();
      } catch (e) {
      }
      (qs[k] = qs[k] || []).push(v);
    });
    Object.keys(qs).forEach(function (key) {
      if (qs[key] && qs[key].length === 1) {
        qs[key] = qs[key][0];
      }
    });
    return qs;
  }

  function setResult() {
    let arr = $('#dimensions').val().split(/[\r\n]/);
    let result = arr
      .filter(function (key) {
        return key;
      })
      .map(function (key) {
        key = key.trim();
        return {
          [key]: getCollectionName(key, $('#jobNameHandle').val() || $('#jobName').val()),
        };
      });

    if (!result.length) {
      result = '';
    }
    if (result.length === 1) {
      result = result[0][Object.keys(result[0])[0]];
    }
    else {
      result = JSON.stringify(result);
    }

    $('#result').val(result);
  }

  function watchChange() {
    $('#dimensions').bind('input propertychange', function () {
      setResult();
    });

    $('#jobName').bind('input propertychange', function () {
      setResult();
    });

    $('#jobNameHandle').bind('input propertychange', function () {
      setResult();
    });

    $('#domain').bind('input propertychange', function () {
      buildNginxConf();
    });
    $('#port').bind('input propertychange', function () {
      buildNginxConf();
    });

    $('#jobContent').bind('input propertychange', function () {
      listJobs();
    });
  }

  var getDomain = (function () {
    var a = document.createElement('a');
    return function (url) {
      url = (url || '').trim();
      if (!/http/.test(url)) {
        url = 'http://' + url;
      }
      a.setAttribute('href', url);
      return a.hostname;
    };
  })();

  function buildNginxConf() {
    var domain = $('#domain').val();
    var port = $('#port').val();
    domain = getDomain(domain);

    var arr = domain.split('.');
    var str1 = arr.join('_');
    var str2 = arr.slice(0, arr.length - 2).join('-');
    var conf = `# HTTP server
upstream ${str1}_backend {
  server 127.0.0.1:${port};
}
# HTTPS server
#
server {
  listen      80;
  server_name ${domain};
  gzip on;
  gzip_proxied any;
  gzip_types text/plain text/xml text/css application/x-javascript application/javascript;
  gzip_vary on;
  gzip_disable "MSIE [1-6]\\.(?!.*SV1)";
  access_log      /var/log/nginx/${str2}-access.log;
  error_log       /var/log/nginx/${str2}-error.log;
  keepalive_timeout    60;
  client_max_body_size    10m;
  error_page 502 /504.html;
  error_page 504 /504.html;
  location /504.html {
    root /home/nodeadmin/static/;
  }
  location / {
    proxy_pass  http://${str1}_backend;
    ### force timeouts if one of backend is died ##
    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
    ### Set headers ####
    proxy_set_header        Accept-Encoding   "";
    proxy_set_header        Host            $host;
    proxy_set_header        X-Real-IP       $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        X-Forwarded-Proto $scheme;
    add_header              Front-End-Https   on;
    ### By default we don't want to redirect it ####
    proxy_redirect     off;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }
}
    `;

    $('#nginxConf').val(conf);
  }

  function listJobs() {
    var str = $('#jobContent').val();

    var jobNameReg = /public\s+class\s+(\w+)\s+extends\s+CubeJob/m;
    var jobName = str.match(jobNameReg)[1];

    var jobDimensionsReg = /\.setOutputDimensions\("([^"]+)"\)/g;

    var arr = [];
    var m;
    while ((m = jobDimensionsReg.exec(str)) !== null) {
      // This is necessary to avoid infinite loops with zero-width matches
      if (m.index === jobDimensionsReg.lastIndex) {
        jobDimensionsReg.lastIndex++;
      }

      arr.push(m[1]);
    }

    console.info('jobName: ', jobName);
    console.info(arr);

    var result = arr
      .map(function (item) {
        return {
          str: item,
          name: getCollectionName(item, jobName),
        };
      })
      .reduce(function (result, obj) {
        result = `${result} <tr><td>${obj.str}</td><td>${obj.name}</td></tr>`;
        return result;
      }, '');


    $('#jobResult').html(`<tr>
        <th>dimension</th>
        <th>collectionName</th>
      </tr>
    ${result}`);
  }


  $(function () {
    loadJobName();
    loadBtnCopy();

    var qs = getQs();
    var hash = getHash();

    if (qs.dimensions || hash.dimensions) {
      $('#dimensions').val(qs.dimensions || hash.dimensions);
    }
    if (qs.job || hash.job) {
      $('#jobName').val(qs.job || hash.job);
    }

    setResult();
    watchChange();
  });
</script>
</body>

</html>