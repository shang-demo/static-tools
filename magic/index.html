<!Doctype html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="shortcut icon" href="//static.xinshangshangxin.com/favicon.ico">
    <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css">
</head>

<body>
    <div class="row">
        <div class="col-xs-4">
            <textarea id="dimensions" class="form-control"></textarea>
        </div>
        <div class="col-xs-4">
            <select class="form-control" id="jobName">
            </select>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-2">
            <button class="btn btn-success copy-btn" data-clipboard-target="#result">复制</button>
        </div>
        <div class="col-xs-10">
            <textarea id="result" class="form-control"></textarea>
        </div>
    </div>
    <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
    <script src="//cdn.bootcss.com/blueimp-md5/2.8.0/js/md5.min.js"></script>
    <script src="//cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="//cdn.bootcss.com/clipboard.js/1.7.1/clipboard.min.js"></script>
    <script src="//cdn.bootcss.com/lodash.js/4.17.4/lodash.min.js"></script>
    <script src="//cdn.bootcss.com/rxjs/5.4.2/Rx.min.js"></script>
    <script>
    function loadJobName() {
        var jobCopys = {
            BusinessAreaLabel: {},
            CrossUserCodeMacAddress: {},
            HomeTownshipLabel: {},
            WorkTownshipLabel: {},
            EnterPoiDeviceDate: {},
            EnterLocDeviceDate: {},
            DeviceAppLabel: {
                properties: {
                    'cn.magicsdk.cube.connections.input': 'deviceMongo'
                }
            },
            DeviceApps: {
                properties: {
                    'cn.magicsdk.cube.connections.input': 'deviceMongo'
                }
            },
            DevicePoiBrandLabel: {},
            DevicePoiCategoryDate: {},
            DevicesTrend: {},
            DevicesTrendByAppWant: {},
            DevicesTrendHeatMap: {},
            DevicesTrendHeatMapByAppWant: {},
            NearbyPoisDeviceTrend: {},
            NearbyPoisTrend: {},
            RealtimeEnterLocDeviceDate: {},
            RealtimeVisitsHeatMapByAppWant: {},
            Test: {},
            UserTypeTrend: {},
            UserTypeTrendByAppWant: {},
            UserTypeTrendHeatMap: {},
            UserTypeTrendHeatMapByAppWant: {},
            VisitsTrend: {},
            VisitsTrendByAppWant: {},
            VisitsTrendHeatMap: {},
            VisitsTrendHeatMapByAppWant: {}
        };

        var options = Object.keys(jobCopys).map(function(key) {
            return `<option value="${key}">${key}</option>`;
        }).join('\n');
        $('#jobName').html(options);
    }



    function getCollectionName(dimensionsStr, jobName) {
        if (!/cn\.magicsdk\.cube\.jobs\./.test(jobName)) {
            jobName = 'cn.magicsdk.cube.jobs.' + jobName;
        }

        var dimensions = dimensionsStr.split(/\s+/);
        var dimensionsStr = jobName + ':' + dimensions.sort().join('|');
        console.log('dimensionsStr: ', dimensionsStr);
        return 'cp_' + md5(dimensionsStr);
    }

    function loadBtnCopy() {
        var clipboard = new Clipboard('.copy-btn');

        clipboard.on('success', function(e) {
            console.info('Action:', e.action);
            console.info('Text:', e.text);
            console.info('Trigger:', e.trigger);

            e.clearSelection();
        });

        clipboard.on('error', function(e) {
            console.error('Action:', e.action);
            console.error('Trigger:', e.trigger);
        });

    }

    function getQs() {
        var qs = {};
        location.search.substr(1).split("&").forEach(function(item) {
            var s = item.split("=");
            var k = s[0];
            var v = s[1] && decodeURIComponent(s[1]);
            try { v = new Function("return " + v)(); } catch (e) {}
            (qs[k] = qs[k] || []).push(v);
        });
        Object.keys(qs).forEach(function(key) { if (qs[key] && qs[key].length === 1) { qs[key] = qs[key][0]; } });

        return qs;
    }

    function getHash() {
        var qs = {};
        location.href.replace(/.*?#\//, '').split("&").forEach(function(item) {
            var s = item.split("=");
            var k = s[0];
            var v = s[1] && decodeURIComponent(s[1]);
            try { v = new Function("return " + v)(); } catch (e) {}
            (qs[k] = qs[k] || []).push(v);
        });
        Object.keys(qs).forEach(function(key) { if (qs[key] && qs[key].length === 1) { qs[key] = qs[key][0]; } });
        return qs;
    }

    function setResult() {
      let arr = $('#dimensions').val().split(/[\r\n]/);
      let result = arr
        .filter(function (key) {
          return key;
        })
        .map(function (key) {
          key = key.trim();
          return {
            [key]: getCollectionName(key, $('#jobName').val()),
          };
        });

      if(!result.length) {
        result = '';
      }
      if (result.length === 1) {
        result = result[0][Object.keys(result[0])[0]];
      }
      else {
        result = JSON.stringify(result);
      }

      $('#result').val(result);
    }

    function watchChange() {
        $('#dimensions').bind('input propertychange', function() {
            setResult();
        });

        $('#jobName').bind('input propertychange', function() {
            setResult();
        });
    }

    $(function() {
        loadJobName();
        loadBtnCopy();

        var qs = getQs();
        var hash = getHash();

        if (qs.dimensions || hash.dimensions) {
            $('#dimensions').val(qs.dimensions || hash.dimensions);
        }
        if (qs.job || hash.job) {
            $('#jobName').val(qs.job || hash.job);
        }

        setResult();
        watchChange();
    });
    </script>
</body>

</html>